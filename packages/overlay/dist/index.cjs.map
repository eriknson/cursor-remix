{"version":3,"sources":["../src/index.ts","../src/runtime/FlowOverlay.tsx","../src/runtime/cn.ts","../src/runtime/constants.ts","../src/runtime/loadReactGrabRuntime.ts","../src/runtime/registerClipboardInterceptor.ts","../src/server/createNextHandler.ts","../src/server/cursorAgent.ts"],"sourcesContent":["export {\n  FlowOverlayProvider,\n  Typewriter,\n  type FlowOverlayProps,\n} from \"./runtime/FlowOverlay\";\nexport {\n  registerClipboardInterceptor,\n  type ClipboardInterceptorOptions,\n} from \"./runtime/registerClipboardInterceptor\";\nexport { loadReactGrabRuntime } from \"./runtime/loadReactGrabRuntime\";\nexport {\n  DEFAULT_MODEL_OPTIONS,\n  DEFAULT_STATUS_SEQUENCE,\n} from \"./runtime/constants\";\nexport type {\n  ModelOption,\n  ShipflowOverlayConfig,\n  StatusSequence,\n} from \"./runtime/types\";\nexport {\n  createNextHandler,\n  type ShipflowOverlayServerOptions,\n  type ShipflowOverlayRequestPayload,\n} from \"./server/createNextHandler\";\n","'use client';\n\nimport {\n  type CSSProperties,\n  type ChangeEvent,\n  useCallback,\n  useEffect,\n  useLayoutEffect,\n  useMemo,\n  useRef,\n  useState,\n  type KeyboardEvent as ReactKeyboardEvent,\n} from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { ArrowUp, Square, Command } from \"lucide-react\";\n\nimport { cn } from \"./cn\";\nimport { DEFAULT_MODEL_OPTIONS, DEFAULT_STATUS_SEQUENCE } from \"./constants\";\nimport type {\n  ModelOption,\n  SelectionPayload,\n  ShipflowOverlayConfig,\n  StatusAddonMode,\n  StatusSequence,\n  StreamEvent,\n} from \"./types\";\nimport { loadReactGrabRuntime } from \"./loadReactGrabRuntime\";\nimport {\n  registerClipboardInterceptor,\n  type ClipboardInterceptorOptions,\n} from \"./registerClipboardInterceptor\";\n\nconst HIGHLIGHT_QUERY = \"[data-react-grab-chat-highlighted='true']\";\nconst EVENT_OPEN = \"react-grab-chat:open\";\nconst EVENT_CLOSE = \"react-grab-chat:close\";\nconst EVENT_UNDO = \"react-grab-chat:undo\";\n\nconst DEFAULT_CONFIG: ShipflowOverlayConfig = {\n  endpoint: \"/api/shipflow/overlay\",\n  models: DEFAULT_MODEL_OPTIONS,\n  statusSequence: DEFAULT_STATUS_SEQUENCE,\n};\n\ntype ChatState = SelectionPayload & {\n  instruction: string;\n  status: \"idle\" | \"submitting\" | \"success\" | \"error\";\n  error?: string;\n  serverMessage?: string;\n  model: string;\n  statusPhase: number;\n  statusAddonMode: StatusAddonMode;\n  statusLabel: string | null;\n  statusContext: string | null;\n  useTypewriter: boolean;\n  summary?: string;\n};\n\nconst DEFAULT_BUBBLE_STYLE: CSSProperties = {\n  top: \"20%\",\n  left: \"50%\",\n  transform: \"translate(-50%, -50%)\",\n};\n\nconst VIEWPORT_MARGIN = 12;\nconst ANCHOR_GAP = 24;\nconst POINTER_HORIZONTAL_GAP = 16;\nconst POINTER_VERTICAL_OFFSET = 12;\n\nconst createInitialState = (\n  models: readonly ModelOption[],\n  statusSequence: StatusSequence,\n): ChatState => ({\n  htmlFrame: null,\n  codeLocation: null,\n  filePath: null,\n  clipboardData: \"\",\n  pointer: null,\n  boundingRect: null,\n  instruction: \"\",\n  status: \"idle\",\n  serverMessage: undefined,\n  error: undefined,\n  model: models[0]?.value ?? \"\",\n  statusPhase: 0,\n  statusAddonMode: \"idle\",\n  statusLabel: statusSequence[0] ?? null,\n  statusContext: null,\n  useTypewriter: true,\n  summary: undefined,\n});\n\nexport type FlowOverlayProps = Partial<ShipflowOverlayConfig> & {\n  enableClipboardInterceptor?: boolean;\n  clipboardOptions?: ClipboardInterceptorOptions;\n};\n\nfunction CursorIcon({ className }: { className?: string }) {\n  return (\n    <svg\n      viewBox=\"0 0 466.73 533.32\"\n      className={className}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      shapeRendering=\"geometricPrecision\"\n    >\n      <path fill=\"#72716d\" d=\"M233.37,266.66l231.16,133.46c-1.42,2.46-3.48,4.56-6.03,6.03l-216.06,124.74c-5.61,3.24-12.53,3.24-18.14,0L8.24,406.15c-2.55-1.47-4.61-3.57-6.03-6.03l231.16-133.46h0Z\" />\n      <path fill=\"#55544f\" d=\"M233.37,0v266.66L2.21,400.12c-1.42-2.46-2.21-5.3-2.21-8.24v-250.44c0-5.89,3.14-11.32,8.24-14.27L224.29,2.43c2.81-1.62,5.94-2.43,9.07-2.43h.01Z\" />\n      <path fill=\"#43413c\" d=\"M464.52,133.2c-1.42-2.46-3.48-4.56-6.03-6.03L242.43,2.43c-2.8-1.62-5.93-2.43-9.06-2.43v266.66l231.16,133.46c1.42-2.46,2.21-5.3,2.21-8.24v-250.44c0-2.95-.78-5.77-2.21-8.24h-.01Z\" />\n      <path fill=\"#d6d5d2\" d=\"M448.35,142.54c1.31,2.26,1.49,5.16,0,7.74l-209.83,363.42c-1.41,2.46-5.16,1.45-5.16-1.38v-239.48c0-1.91-.51-3.75-1.44-5.36l216.42-124.95h.01Z\" />\n      <path fill=\"#fff\" d=\"M448.35,142.54l-216.42,124.95c-.92-1.6-2.26-2.96-3.92-3.92L20.62,143.83c-2.46-1.41-1.45-5.16,1.38-5.16h419.65c2.98,0,5.4,1.61,6.7,3.87Z\" />\n    </svg>\n  );\n}\n\nfunction useSelectionEvents(\n  onOpen: (payload: SelectionPayload) => void,\n  onClose: () => void,\n  isOpen: boolean,\n) {\n  useEffect(() => {\n    const handler = (event: Event) => {\n      const custom = event as CustomEvent<SelectionPayload>;\n      if (!custom.detail) return;\n\n      if (isOpen) {\n        onClose();\n      }\n\n      onOpen(custom.detail);\n    };\n\n    window.addEventListener(EVENT_OPEN, handler as EventListener);\n    return () => window.removeEventListener(EVENT_OPEN, handler as EventListener);\n  }, [onOpen, onClose, isOpen]);\n}\n\nfunction useRecalculateRect(\n  chat: ChatState | null,\n  setChat: React.Dispatch<React.SetStateAction<ChatState | null>>,\n) {\n  useEffect(() => {\n    if (!chat) return;\n\n    const updateRect = () => {\n      const element = document.querySelector(HIGHLIGHT_QUERY);\n\n      if (!(element instanceof HTMLElement)) {\n        setChat((current) => {\n          if (!current || current.boundingRect === null) {\n            return current;\n          }\n          return { ...current, boundingRect: null };\n        });\n        return;\n      }\n\n      const rect = element.getBoundingClientRect();\n      const scrollX = window.scrollX;\n      const scrollY = window.scrollY;\n\n      const nextRect = {\n        top: rect.top + scrollY,\n        left: rect.left + scrollX,\n        width: rect.width,\n        height: rect.height,\n      };\n\n      setChat((current) => {\n        if (!current) {\n          return current;\n        }\n\n        const prev = current.boundingRect;\n        const hasChanged =\n          !prev ||\n          prev.top !== nextRect.top ||\n          prev.left !== nextRect.left ||\n          prev.width !== nextRect.width ||\n          prev.height !== nextRect.height;\n\n        if (!hasChanged) {\n          return current;\n        }\n\n        return {\n          ...current,\n          boundingRect: nextRect,\n        };\n      });\n    };\n\n    updateRect();\n    window.addEventListener(\"scroll\", updateRect, true);\n    window.addEventListener(\"resize\", updateRect);\n\n    return () => {\n      window.removeEventListener(\"scroll\", updateRect, true);\n      window.removeEventListener(\"resize\", updateRect);\n    };\n  }, [chat, setChat]);\n}\n\nfunction useEscapeToClose(isOpen: boolean, onClose: () => void) {\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handler = (event: KeyboardEvent) => {\n      if (event.key === \"Escape\") {\n        event.preventDefault();\n        onClose();\n      }\n    };\n\n    window.addEventListener(\"keydown\", handler, true);\n    return () => window.removeEventListener(\"keydown\", handler, true);\n  }, [isOpen, onClose]);\n}\n\nfunction useAutoFocus(isOpen: boolean) {\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const frame = requestAnimationFrame(() => {\n      const textarea = document.querySelector<HTMLTextAreaElement>(\n        \"[data-react-grab-chat-input='true']\",\n      );\n      textarea?.focus();\n      textarea?.select();\n    });\n\n    return () => cancelAnimationFrame(frame);\n  }, [isOpen]);\n}\n\nfunction useClickOutside(\n  ref: React.RefObject<HTMLElement | null>,\n  isOpen: boolean,\n  onClose: () => void,\n) {\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as Node;\n      if (ref.current && !ref.current.contains(target)) {\n        const highlightedElement = document.querySelector(HIGHLIGHT_QUERY);\n        if (!highlightedElement || !highlightedElement.contains(target)) {\n          onClose();\n        }\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside, true);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside, true);\n    };\n  }, [ref, isOpen, onClose]);\n}\n\nfunction Typewriter({ text }: { text: string }) {\n  const [displayed, setDisplayed] = useState(\"\");\n\n  useEffect(() => {\n    setDisplayed(\"\");\n    let i = 0;\n    const timer = setInterval(() => {\n      if (i < text.length) {\n        setDisplayed(text.slice(0, i + 1));\n        i++;\n      } else {\n        clearInterval(timer);\n      }\n    }, 15);\n    return () => clearInterval(timer);\n  }, [text]);\n\n  return <>{displayed}</>;\n}\n\nfunction Bubble({\n  chat,\n  onInstructionChange,\n  onSubmit,\n  onStop,\n  onModelChange,\n  onClose,\n  modelOptions,\n  statusSequence,\n}: {\n  chat: ChatState;\n  onInstructionChange: (value: string) => void;\n  onSubmit: () => void;\n  onStop: () => void;\n  onModelChange: (value: string) => void;\n  onClose: () => void;\n  modelOptions: readonly ModelOption[];\n  statusSequence: StatusSequence;\n}) {\n  const anchor = chat.boundingRect;\n  const bubbleRef = useRef<HTMLDivElement | null>(null);\n  const [bubbleSize, setBubbleSize] = useState<{ width: number; height: number } | null>(null);\n  const [bubbleStyle, setBubbleStyle] = useState<CSSProperties>(DEFAULT_BUBBLE_STYLE);\n  const textareaRef = useRef<HTMLTextAreaElement | null>(null);\n\n  useClickOutside(bubbleRef, true, onClose);\n\n  useLayoutEffect(() => {\n    const node = bubbleRef.current;\n    if (!node) return;\n\n    const updateSize = () => {\n      const rect = node.getBoundingClientRect();\n      setBubbleSize((prev) => {\n        if (prev && prev.width === rect.width && prev.height === rect.height) {\n          return prev;\n        }\n        return { width: rect.width, height: rect.height };\n      });\n    };\n\n    updateSize();\n\n    if (typeof ResizeObserver !== \"undefined\") {\n      const observer = new ResizeObserver(() => {\n        updateSize();\n      });\n      observer.observe(node);\n      return () => observer.disconnect();\n    }\n\n    window.addEventListener(\"resize\", updateSize);\n    return () => {\n      window.removeEventListener(\"resize\", updateSize);\n    };\n  }, []);\n\n  useLayoutEffect(() => {\n    if (!bubbleSize) {\n      setBubbleStyle((prev) => (prev === DEFAULT_BUBBLE_STYLE ? prev : DEFAULT_BUBBLE_STYLE));\n      return;\n    }\n\n    if (typeof window === \"undefined\") {\n      return;\n    }\n\n    const viewportWidth = window.innerWidth;\n    const viewportHeight = window.innerHeight;\n    const scrollX = window.scrollX;\n    const scrollY = window.scrollY;\n    const verticalGap = ANCHOR_GAP;\n    const horizontalGap = ANCHOR_GAP;\n\n    const clampHorizontal = (value: number) => {\n      const min = VIEWPORT_MARGIN;\n      const max = viewportWidth - VIEWPORT_MARGIN - bubbleSize.width;\n      if (min > max) {\n        return (viewportWidth - bubbleSize.width) / 2;\n      }\n      return Math.min(Math.max(value, min), max);\n    };\n\n    const clampVertical = (value: number) => {\n      const min = VIEWPORT_MARGIN;\n      const max = viewportHeight - VIEWPORT_MARGIN - bubbleSize.height;\n      if (min > max) {\n        return (viewportHeight - bubbleSize.height) / 2;\n      }\n      return Math.min(Math.max(value, min), max);\n    };\n\n    const computeOverflow = (top: number, left: number) => {\n      const overflowTop = Math.max(VIEWPORT_MARGIN - top, 0);\n      const overflowBottom = Math.max(\n        top + bubbleSize.height - (viewportHeight - VIEWPORT_MARGIN),\n        0,\n      );\n      const overflowLeft = Math.max(VIEWPORT_MARGIN - left, 0);\n      const overflowRight = Math.max(\n        left + bubbleSize.width - (viewportWidth - VIEWPORT_MARGIN),\n        0,\n      );\n\n      return overflowTop + overflowBottom + overflowLeft + overflowRight;\n    };\n\n    const pointer = chat.pointer;\n    let bestStyle: CSSProperties | null = null;\n\n    if (anchor) {\n      const anchorViewport = {\n        top: anchor.top - scrollY,\n        left: anchor.left - scrollX,\n        width: anchor.width,\n        height: anchor.height,\n      };\n\n      const anchorCenterX = anchorViewport.left + anchorViewport.width / 2;\n      const anchorCenterY = anchorViewport.top + anchorViewport.height / 2;\n\n      type CandidateName = \"bottom\" | \"top\" | \"right\" | \"left\";\n\n      type Candidate = {\n        name: CandidateName;\n        top: number;\n        left: number;\n        fits: boolean;\n        overflow: number;\n      };\n\n      const candidates: Candidate[] = [];\n\n      const bottomTop = anchorViewport.top + anchorViewport.height + verticalGap;\n      const bottomLeft = clampHorizontal(anchorCenterX - bubbleSize.width / 2);\n      candidates.push({\n        name: \"bottom\",\n        top: bottomTop,\n        left: bottomLeft,\n        fits: bottomTop + bubbleSize.height <= viewportHeight - VIEWPORT_MARGIN,\n        overflow: computeOverflow(bottomTop, bottomLeft),\n      });\n\n      const topTop = anchorViewport.top - verticalGap - bubbleSize.height;\n      const topLeft = clampHorizontal(anchorCenterX - bubbleSize.width / 2);\n      candidates.push({\n        name: \"top\",\n        top: topTop,\n        left: topLeft,\n        fits: topTop >= VIEWPORT_MARGIN,\n        overflow: computeOverflow(topTop, topLeft),\n      });\n\n      const rightLeft = anchorViewport.left + anchorViewport.width + horizontalGap;\n      const rightTop = clampVertical(anchorCenterY - bubbleSize.height / 2);\n      candidates.push({\n        name: \"right\",\n        top: rightTop,\n        left: rightLeft,\n        fits: rightLeft + bubbleSize.width <= viewportWidth - VIEWPORT_MARGIN,\n        overflow: computeOverflow(rightTop, rightLeft),\n      });\n\n      const leftLeft = anchorViewport.left - horizontalGap - bubbleSize.width;\n      const leftTop = clampVertical(anchorCenterY - bubbleSize.height / 2);\n      candidates.push({\n        name: \"left\",\n        top: leftTop,\n        left: leftLeft,\n        fits: leftLeft >= VIEWPORT_MARGIN,\n        overflow: computeOverflow(leftTop, leftLeft),\n      });\n\n      const baseOrder: CandidateName[] = [\"bottom\", \"top\", \"right\", \"left\"];\n      const orderedCandidates = baseOrder\n        .map((name) => candidates.find((candidate) => candidate.name === name))\n        .filter((candidate): candidate is Candidate => Boolean(candidate));\n\n      const perfectCandidate = orderedCandidates.find(\n        (candidate) => candidate.fits && candidate.overflow === 0,\n      );\n\n      if (perfectCandidate) {\n        bestStyle = {\n          top: `${Math.round(perfectCandidate.top + scrollY)}px`,\n          left: `${Math.round(perfectCandidate.left + scrollX)}px`,\n        };\n      } else if (!pointer) {\n        const bestCandidate =\n          orderedCandidates.find((candidate) => candidate.fits) ??\n          (orderedCandidates.length > 0\n            ? orderedCandidates.reduce(\n                (best, candidate) => (candidate.overflow < best.overflow ? candidate : best),\n                orderedCandidates[0],\n              )\n            : null);\n\n        if (bestCandidate) {\n          bestStyle = {\n            top: `${Math.round(bestCandidate.top + scrollY)}px`,\n            left: `${Math.round(bestCandidate.left + scrollX)}px`,\n          };\n        }\n      }\n    }\n\n    if (!bestStyle && pointer) {\n      const pointerTopRaw = pointer.y - POINTER_VERTICAL_OFFSET;\n      const clampedTop = clampVertical(pointerTopRaw);\n\n      const rightLeftRaw = pointer.x + POINTER_HORIZONTAL_GAP;\n      const fitsRight = rightLeftRaw + bubbleSize.width <= viewportWidth - VIEWPORT_MARGIN;\n\n      let targetLeft = rightLeftRaw;\n      if (!fitsRight) {\n        const leftLeftRaw = pointer.x - POINTER_HORIZONTAL_GAP - bubbleSize.width;\n        targetLeft = leftLeftRaw;\n      }\n\n      const clampedLeft = clampHorizontal(targetLeft);\n\n      bestStyle = {\n        top: `${Math.round(clampedTop + scrollY)}px`,\n        left: `${Math.round(clampedLeft + scrollX)}px`,\n      };\n    }\n\n    if (bestStyle) {\n      setBubbleStyle((prev) => {\n        if (\n          prev.top === bestStyle!.top &&\n          prev.left === bestStyle!.left &&\n          !(\"transform\" in prev)\n        ) {\n          return prev;\n        }\n        return bestStyle!;\n      });\n      return;\n    }\n\n    setBubbleStyle((prev) => (prev === DEFAULT_BUBBLE_STYLE ? prev : DEFAULT_BUBBLE_STYLE));\n  }, [anchor, bubbleSize, chat.pointer]);\n\n  const isSubmitting = chat.status === \"submitting\";\n  const hasInput = chat.instruction.trim().length > 0;\n  const showExpandedLayout = hasInput || chat.status !== \"idle\";\n  const disableEditing = isSubmitting;\n  const computedStatusLabel =\n    chat.statusLabel ?? statusSequence[chat.statusPhase] ?? statusSequence[0] ?? null;\n\n  const handleUndo = useCallback(() => {\n    if (chat.statusAddonMode !== \"summary\") {\n      return;\n    }\n\n    window.dispatchEvent(\n      new CustomEvent(EVENT_UNDO, {\n        detail: {\n          instruction: chat.instruction,\n          summary: chat.summary ?? null,\n          filePath: chat.filePath,\n        },\n      }),\n    );\n  }, [chat]);\n\n  useEffect(() => {\n    const textarea = textareaRef.current;\n    if (!textarea) return;\n\n    const minRows = showExpandedLayout ? 2 : 1;\n    textarea.rows = minRows;\n    textarea.style.height = \"auto\";\n    const computedStyles = window.getComputedStyle(textarea);\n    const lineHeight = parseFloat(computedStyles.lineHeight) || 24;\n    const borderOffset = textarea.offsetHeight - textarea.clientHeight;\n    const minHeight = lineHeight * minRows + borderOffset;\n    textarea.style.height = `${Math.max(textarea.scrollHeight, minHeight)}px`;\n  }, [chat.instruction, showExpandedLayout]);\n\n  const handleKeyDown = useCallback(\n    (event: ReactKeyboardEvent<HTMLTextAreaElement>) => {\n      if (event.key !== \"Enter\") return;\n      if (event.shiftKey) {\n        return;\n      }\n      event.preventDefault();\n      if (!isSubmitting && hasInput) {\n        onSubmit();\n      }\n    },\n    [hasInput, isSubmitting, onSubmit],\n  );\n\n  const handleChange = useCallback(\n    (event: ChangeEvent<HTMLTextAreaElement>) => {\n      onInstructionChange(event.target.value);\n    },\n    [onInstructionChange],\n  );\n\n  return (\n    <div\n      ref={bubbleRef}\n      className={cn(\n        \"absolute z-[2147483647] flex w-full max-w-[400px] flex-col overflow-hidden rounded-xl border border-neutral-200/40 bg-neutral-50/60 text-neutral-900 shadow-2xl backdrop-blur-2xl font-sans dark:border-neutral-700/40 dark:bg-neutral-900/60 dark:text-neutral-50\",\n        \"animate-in fade-in-0 zoom-in-95 duration-100 ease-out\",\n      )}\n      style={bubbleStyle}\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-label=\"Shipflow overlay request\"\n      data-react-grab-chat-bubble=\"true\"\n      data-react-grab=\"true\"\n    >\n      <div\n        className={cn(\n          \"flex w-full flex-col p-3\",\n          showExpandedLayout ? \"gap-2\" : \"gap-0\",\n        )}\n      >\n        <div className=\"relative flex w-full items-center gap-3\">\n          <textarea\n            ref={textareaRef}\n            data-react-grab-chat-input=\"true\"\n            rows={showExpandedLayout ? 2 : 1}\n            className={cn(\n              \"w-full resize-none bg-transparent text-sm font-normal leading-relaxed text-neutral-800 placeholder:text-neutral-400 outline-none dark:text-neutral-100 dark:placeholder:text-neutral-500\",\n              disableEditing && \"opacity-50\",\n              !showExpandedLayout && \"pr-10\",\n            )}\n            placeholder=\"Change anything\"\n            value={chat.instruction}\n            onChange={handleChange}\n            onKeyDown={handleKeyDown}\n            disabled={disableEditing}\n          />\n\n          {!showExpandedLayout ? (\n            <button\n              type=\"button\"\n              onClick={onSubmit}\n              disabled={!hasInput || isSubmitting}\n              className={cn(\n                \"absolute right-0 top-1/2 -translate-y-1/2 flex h-8 w-8 items-center justify-center rounded-full bg-neutral-300/50 text-neutral-600 transition hover:bg-neutral-300/80 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-neutral-700/50 dark:text-neutral-300 dark:hover:bg-neutral-700/80\",\n              )}\n            >\n              <ArrowUp className=\"h-4 w-4\" />\n            </button>\n          ) : null}\n        </div>\n\n        {showExpandedLayout ? (\n          <div className=\"flex items-center justify-between animate-in fade-in slide-in-from-top-1 duration-150 ease-out\">\n            <div className=\"relative inline-flex\">\n              <select\n                aria-label=\"Model selection\"\n                className={cn(\n                  \"h-8 w-auto appearance-none rounded-lg bg-neutral-200/50 pl-3 pr-[26px] text-xs font-medium text-neutral-500 transition hover:bg-neutral-200/70 focus:outline-none focus:ring-2 focus:ring-neutral-300/50 disabled:cursor-not-allowed disabled:opacity-60 dark:bg-neutral-800/50 dark:text-neutral-400 dark:hover:bg-neutral-800/70 dark:focus:ring-neutral-700/50\",\n                )}\n                value={chat.model}\n                onChange={(event) => onModelChange(event.target.value)}\n                disabled={disableEditing}\n              >\n                {modelOptions.map((option) => (\n                  <option key={option.value} value={option.value}>\n                    {option.label}\n                  </option>\n                ))}\n              </select>\n              <span className=\"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-neutral-500\">\n                <svg width=\"10\" height=\"6\" viewBox=\"0 0 10 6\" fill=\"none\">\n                  <path d=\"M1 1l4 4 4-4\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n                </svg>\n              </span>\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={isSubmitting ? onStop : onSubmit}\n              disabled={!hasInput && !isSubmitting}\n              className={cn(\n                \"flex h-8 w-8 items-center justify-center rounded-full transition-all duration-200\",\n                isSubmitting\n                  ? \"bg-neutral-900 text-white hover:bg-neutral-800 dark:bg-white dark:text-black dark:hover:bg-neutral-200\"\n                  : \"bg-neutral-900 text-white shadow-lg hover:bg-neutral-800 hover:scale-105 dark:bg-white dark:text-black dark:hover:bg-neutral-200\",\n                !hasInput && !isSubmitting && \"opacity-0 pointer-events-none\",\n              )}\n            >\n              {isSubmitting ? (\n                <Square className=\"h-3 w-3 fill-current\" />\n              ) : (\n                <ArrowUp className=\"h-4 w-4\" />\n              )}\n            </button>\n          </div>\n        ) : null}\n      </div>\n\n      {chat.statusAddonMode !== \"idle\" && (\n        <div className=\"flex w-full flex-col border-t border-neutral-200/30 bg-neutral-100/30 px-3 py-2 backdrop-blur-xl dark:border-neutral-800/30 dark:bg-neutral-900/30 animate-in fade-in slide-in-from-top-1 duration-150 ease-out\">\n          {chat.statusAddonMode === \"progress\" ? (\n            <div className=\"flex items-center justify-between gap-3 text-xs font-medium\">\n              <div className=\"flex items-center gap-2 shrink-0\">\n                <CursorIcon className=\"h-3.5 w-3.5 animate-pulse-subtle\" />\n                <span className=\"bg-gradient-to-r from-neutral-600 via-neutral-600/40 to-neutral-600 bg-[length:200%_100%] bg-clip-text text-transparent animate-shimmer dark:from-neutral-400 dark:via-neutral-400/40 dark:to-neutral-400 opacity-60\">\n                  {computedStatusLabel}\n                </span>\n              </div>\n              {chat.statusContext && (\n                <span className=\"min-w-0 flex-1 truncate text-right text-neutral-400 dark:text-neutral-500\">\n                  {chat.useTypewriter ? <Typewriter text={chat.statusContext} /> : chat.statusContext}\n                </span>\n              )}\n            </div>\n          ) : chat.statusAddonMode === \"summary\" && chat.summary ? (\n            <div className=\"flex items-center justify-between text-xs font-medium\">\n              <div className=\"flex items-center gap-2 text-neutral-600 dark:text-neutral-400\">\n                <CursorIcon className=\"h-3.5 w-3.5\" />\n                <span>Changes applied</span>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={handleUndo}\n                  className=\"flex items-center gap-1 text-neutral-400 transition hover:text-neutral-900 dark:text-neutral-500 dark:hover:text-neutral-200\"\n                >\n                  Undo <Command className=\"h-3 w-3 ml-0.5\" /> Z\n                </button>\n              </div>\n            </div>\n          ) : null}\n        </div>\n      )}\n\n      {chat.error ? (\n        <div className=\"border-t border-red-200/50 bg-red-50/50 px-3 py-2 text-xs font-medium text-red-600 backdrop-blur-xl dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200\">\n          {chat.error}\n        </div>\n      ) : null}\n    </div>\n  );\n}\n\nexport function FlowOverlayProvider(props: FlowOverlayProps = {}) {\n  const clipboardOptions = useMemo(\n    () => props.clipboardOptions ?? {},\n    [props.clipboardOptions],\n  );\n\n  const config = useMemo<ShipflowOverlayConfig>(() => {\n    const models =\n      props.models && props.models.length > 0 ? props.models : DEFAULT_CONFIG.models;\n    const statusSequence =\n      props.statusSequence && props.statusSequence.length > 0\n        ? props.statusSequence\n        : DEFAULT_CONFIG.statusSequence;\n    const endpoint = props.endpoint ?? DEFAULT_CONFIG.endpoint;\n\n    return {\n      endpoint,\n      models,\n      statusSequence,\n    };\n  }, [props.endpoint, props.models, props.statusSequence]);\n\n  const [chat, setChat] = useState<ChatState | null>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const fallbackStatusLabel = config.statusSequence[0] ?? null;\n\n  useEffect(() => {\n    if (props.enableClipboardInterceptor === false) {\n      return;\n    }\n\n    let cleanup: (() => void) | undefined;\n\n    loadReactGrabRuntime({\n      url: clipboardOptions.reactGrabUrl,\n    })\n      .then(() => {\n        cleanup = registerClipboardInterceptor({\n          projectRoot: clipboardOptions.projectRoot,\n          highlightColor: clipboardOptions.highlightColor,\n          highlightStyleId: clipboardOptions.highlightStyleId,\n          logClipboardEndpoint:\n            clipboardOptions.logClipboardEndpoint ??\n            process.env.SHIPFLOW_OVERLAY_LOG_ENDPOINT ??\n            null,\n          reactGrabUrl: clipboardOptions.reactGrabUrl,\n        });\n      })\n      .catch((error) => {\n        console.error(\"[shipflow-overlay] Failed to load React Grab runtime\", error);\n      });\n\n    return () => {\n      cleanup?.();\n    };\n  }, [\n    clipboardOptions.highlightColor,\n    clipboardOptions.highlightStyleId,\n    clipboardOptions.logClipboardEndpoint,\n    clipboardOptions.projectRoot,\n    clipboardOptions.reactGrabUrl,\n    props.enableClipboardInterceptor,\n  ]);\n\n  const close = useCallback(() => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      abortControllerRef.current = null;\n    }\n    setChat(null);\n    window.dispatchEvent(new Event(EVENT_CLOSE));\n  }, []);\n\n  const buildInitialState = useCallback(\n    () => createInitialState(config.models, config.statusSequence),\n    [config.models, config.statusSequence],\n  );\n\n  useSelectionEvents(\n    useCallback(\n      (payload: SelectionPayload) => {\n        setChat({\n          ...buildInitialState(),\n          ...payload,\n        });\n      },\n      [buildInitialState],\n    ),\n    close,\n    Boolean(chat),\n  );\n\n  useRecalculateRect(chat, setChat);\n  useEscapeToClose(Boolean(chat), close);\n  useAutoFocus(Boolean(chat));\n\n  const sendToBackend = useCallback(\n    async (payload: {\n      filePath: string | null;\n      htmlFrame: string | null;\n      stackTrace: string | null;\n      instruction: string;\n      model: string;\n    }) => {\n      const controller = new AbortController();\n      abortControllerRef.current = controller;\n\n      const promotePhase = (phase: number) => {\n        const safePhase = Math.min(Math.max(phase, 0), config.statusSequence.length - 1);\n        setChat((prev) => {\n          if (!prev) return prev;\n          if (prev.statusPhase === safePhase && prev.statusLabel) {\n            return prev;\n          }\n          return {\n            ...prev,\n            statusPhase: safePhase,\n            statusLabel: config.statusSequence[safePhase] ?? fallbackStatusLabel,\n          };\n        });\n      };\n\n      try {\n        const response = await fetch(config.endpoint, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n          signal: controller.signal,\n          body: JSON.stringify(payload),\n        });\n\n        if (!response.ok) {\n          const data = await response.json().catch(() => null);\n          throw new Error(data?.error ?? `Request failed with status ${response.status}`);\n        }\n\n        const reader = response.body?.getReader();\n        if (!reader) {\n          throw new Error(\"Streaming response is not supported in this environment.\");\n        }\n\n        const decoder = new TextDecoder();\n        let buffer = \"\";\n        let assistantSummary = \"\";\n        let hasPromotedPlanning = false;\n        let hasPromotedUpdating = false;\n\n        const processEvent = (event: StreamEvent) => {\n          if (event.event === \"status\") {\n            const message = event.message?.trim();\n            if (message) {\n              if (!hasPromotedPlanning && /plan|analy/i.test(message)) {\n                promotePhase(1);\n                hasPromotedPlanning = true;\n              }\n              if (!hasPromotedUpdating && /apply|build|final|update/i.test(message)) {\n                promotePhase(2);\n                hasPromotedUpdating = true;\n              }\n              setChat((prev) =>\n                prev\n                  ? {\n                      ...prev,\n                      statusContext: message,\n                      useTypewriter: true,\n                    }\n                  : prev,\n              );\n            }\n            if (!hasPromotedPlanning) {\n              promotePhase(0);\n            }\n            return;\n          }\n\n          if (event.event === \"assistant\") {\n            const chunk = event.text?.trim();\n            if (chunk) {\n              assistantSummary += chunk.endsWith(\"\\n\") ? chunk : `${chunk} `;\n              if (!hasPromotedPlanning) {\n                promotePhase(1);\n                hasPromotedPlanning = true;\n              }\n              setChat((prev) =>\n                prev\n                  ? {\n                      ...prev,\n                      statusContext: chunk,\n                      useTypewriter: false,\n                    }\n                  : prev,\n              );\n            }\n            return;\n          }\n\n          if (event.event === \"done\") {\n            if (event.success) {\n              promotePhase(2);\n              hasPromotedUpdating = true;\n              const summary =\n                event.summary?.trim() || assistantSummary.trim() || \"Changes applied.\";\n              setChat((prev) =>\n                prev\n                  ? {\n                      ...prev,\n                      status: \"success\",\n                      instruction: \"\",\n                      statusAddonMode: \"summary\",\n                      summary,\n                      statusLabel: null,\n                      statusContext: null,\n                      statusPhase: Math.max(config.statusSequence.length - 1, 0),\n                      serverMessage: event.stderr ? event.stderr.trim() : prev.serverMessage,\n                    }\n                  : prev,\n              );\n            } else {\n              setChat((prev) =>\n                prev\n                  ? {\n                      ...prev,\n                      status: \"error\",\n                      error: event.error ?? \"Cursor CLI reported an error.\",\n                      statusAddonMode: \"idle\",\n                      statusLabel: null,\n                      statusContext: null,\n                      summary: undefined,\n                      statusPhase: 0,\n                      serverMessage: event.stderr ? event.stderr.trim() : prev.serverMessage,\n                    }\n                  : prev,\n              );\n            }\n          }\n        };\n\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) {\n            break;\n          }\n\n          buffer += decoder.decode(value, { stream: true });\n          let newlineIndex = buffer.indexOf(\"\\n\");\n\n          while (newlineIndex !== -1) {\n            const line = buffer.slice(0, newlineIndex).trim();\n            buffer = buffer.slice(newlineIndex + 1);\n            if (line) {\n              try {\n                processEvent(JSON.parse(line) as StreamEvent);\n              } catch (error) {\n                console.warn(\"[shipflow-overlay] Unable to parse stream line\", { line, error });\n              }\n            }\n            newlineIndex = buffer.indexOf(\"\\n\");\n          }\n        }\n\n        buffer += decoder.decode();\n        const finalLine = buffer.trim();\n        if (finalLine) {\n          try {\n            processEvent(JSON.parse(finalLine) as StreamEvent);\n          } catch (error) {\n            console.warn(\"[shipflow-overlay] Unable to parse final stream line\", { finalLine, error });\n          }\n        }\n      } catch (error) {\n        if (controller.signal.aborted) {\n          setChat((prev) =>\n            prev\n              ? {\n                  ...prev,\n                  status: \"idle\",\n                  statusAddonMode: \"idle\",\n                  statusLabel: null,\n                  statusContext: null,\n                  summary: undefined,\n                  error: undefined,\n                  serverMessage: undefined,\n                  statusPhase: 0,\n                }\n              : prev,\n          );\n          return;\n        }\n\n        console.error(\"[shipflow-overlay] Failed to communicate with Cursor CLI backend\", error);\n        setChat((prev) =>\n          prev\n            ? {\n                ...prev,\n                status: \"error\",\n                error: error instanceof Error ? error.message : \"Unable to send request.\",\n                statusAddonMode: \"idle\",\n                statusLabel: null,\n                statusContext: null,\n                summary: undefined,\n              }\n            : prev,\n        );\n      } finally {\n        if (abortControllerRef.current === controller) {\n          abortControllerRef.current = null;\n        }\n      }\n    },\n    [config.endpoint, config.models, config.statusSequence, fallbackStatusLabel],\n  );\n\n  const onInstructionChange = useCallback((value: string) => {\n    setChat((current) => {\n      if (!current) {\n        return current;\n      }\n\n      const next: ChatState = {\n        ...current,\n        instruction: value,\n      };\n\n      if (current.status !== \"submitting\") {\n        next.status = \"idle\";\n      }\n\n      if (value.length > 0 && current.statusAddonMode !== \"idle\") {\n        next.statusAddonMode = \"idle\";\n        next.statusLabel = null;\n        next.statusContext = null;\n        next.summary = undefined;\n        next.statusPhase = 0;\n      }\n\n      if (current.status === \"error\") {\n        next.error = undefined;\n      }\n\n      return next;\n    });\n  }, []);\n\n  const onSubmit = useCallback(() => {\n    let payload:\n      | {\n          filePath: string | null;\n          htmlFrame: string | null;\n          stackTrace: string | null;\n          instruction: string;\n          model: string;\n        }\n      | null = null;\n\n    setChat((current) => {\n      if (!current) return current;\n      if (current.status === \"submitting\") return current;\n\n      const trimmed = current.instruction.trim();\n      if (!trimmed) {\n        return {\n          ...current,\n          error: \"Please describe the change.\",\n          status: \"error\",\n          statusAddonMode: \"idle\",\n          statusLabel: null,\n          statusContext: null,\n          summary: undefined,\n          statusPhase: 0,\n          serverMessage: undefined,\n        };\n      }\n\n      payload = {\n        filePath: current.filePath,\n        htmlFrame: current.htmlFrame,\n        stackTrace: current.codeLocation,\n        instruction: trimmed,\n        model: current.model || config.models[0]?.value || \"\",\n      };\n\n      return {\n        ...current,\n        instruction: trimmed,\n        status: \"submitting\",\n        error: undefined,\n        serverMessage: undefined,\n        statusAddonMode: \"progress\",\n        statusLabel: config.statusSequence[0] ?? fallbackStatusLabel,\n        statusContext: \"Preparing Cursor CLI requestâ€¦\",\n        summary: undefined,\n        statusPhase: 0,\n      };\n    });\n\n    if (payload) {\n      void sendToBackend(payload);\n    }\n  }, [config.models, config.statusSequence, fallbackStatusLabel, sendToBackend]);\n\n  const stop = useCallback(() => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n    }\n  }, []);\n\n  const onModelChange = useCallback(\n    (value: string) => {\n      setChat((current) => {\n        if (!current || current.status === \"submitting\") {\n          return current;\n        }\n        const nextValue = config.models.some((option) => option.value === value)\n          ? value\n          : config.models[0]?.value ?? \"\";\n        return { ...current, model: nextValue };\n      });\n    },\n    [config.models],\n  );\n\n  const bubble = chat ? (\n    <Bubble\n      chat={chat}\n      onInstructionChange={onInstructionChange}\n      onSubmit={onSubmit}\n      onStop={stop}\n      onModelChange={onModelChange}\n      onClose={close}\n      modelOptions={config.models}\n      statusSequence={config.statusSequence}\n    />\n  ) : null;\n\n  if (!bubble) return null;\n\n  return createPortal(bubble, document.body);\n}\n\nexport { Typewriter };\n","import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n","export const DEFAULT_STATUS_SEQUENCE = [\n  \"Thinking\",\n  \"Planning next moves\",\n  \"Updating UI\",\n] as const;\n\nexport const DEFAULT_MODEL_OPTIONS = [\n  { value: \"composer-1\", label: \"Composer 1\" },\n  { value: \"gpt-5\", label: \"GPT-5\" },\n  { value: \"sonnet-4.5\", label: \"Sonnet 4.5\" },\n  { value: \"gemini-3\", label: \"Gemini 3\" },\n] as const;\n","const DEFAULT_SCRIPT_URL = \"https://unpkg.com/react-grab@0.0.51/dist/index.global.js\";\nconst GLOBAL_FLAG = \"__shipflowReactGrabLoaded\";\n\ntype LoadOptions = {\n  url?: string;\n};\n\nlet pendingLoad: Promise<void> | null = null;\n\nexport function loadReactGrabRuntime(options: LoadOptions = {}): Promise<void> {\n  if (typeof window === \"undefined\") {\n    return Promise.resolve();\n  }\n\n  if ((window as unknown as Record<string, unknown>)[GLOBAL_FLAG]) {\n    return Promise.resolve();\n  }\n\n  if (pendingLoad) {\n    return pendingLoad;\n  }\n\n  const scriptUrl = options.url ?? DEFAULT_SCRIPT_URL;\n\n  pendingLoad = new Promise<void>((resolve, reject) => {\n    const existing = Array.from(document.scripts).find((script) => script.src === scriptUrl);\n    if (existing) {\n      (window as unknown as Record<string, unknown>)[GLOBAL_FLAG] = true;\n      pendingLoad = null;\n      resolve();\n      return;\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = scriptUrl;\n    script.crossOrigin = \"anonymous\";\n    script.async = false;\n    script.onload = () => {\n      (window as unknown as Record<string, unknown>)[GLOBAL_FLAG] = true;\n      pendingLoad = null;\n      resolve();\n    };\n    script.onerror = (error) => {\n      pendingLoad = null;\n      reject(error instanceof ErrorEvent ? error.error : error);\n    };\n    document.head.appendChild(script);\n  });\n\n  return pendingLoad;\n}\n","import { loadReactGrabRuntime } from \"./loadReactGrabRuntime\";\nimport type { SelectionPayload } from \"./types\";\n\nconst GLOBAL_KEY = \"__shipflowOverlayCleanup\";\nconst HIGHLIGHT_ATTR = \"data-react-grab-chat-highlighted\";\nconst STYLE_ID = \"shipflow-overlay-highlight-style\";\nconst EVENT_OPEN = \"react-grab-chat:open\";\nconst EVENT_CLOSE = \"react-grab-chat:close\";\n\ntype ClipboardParseResult = {\n  htmlFrame: string | null;\n  codeLocation: string | null;\n};\n\nexport type ClipboardInterceptorOptions = {\n  projectRoot?: string;\n  highlightColor?: string;\n  highlightStyleId?: string;\n  logClipboardEndpoint?: string | null;\n  reactGrabUrl?: string;\n};\n\nconst defaultOptions: Required<Pick<ClipboardInterceptorOptions, \"highlightColor\" | \"highlightStyleId\">> =\n  {\n    highlightColor: \"#ff40e0\",\n    highlightStyleId: STYLE_ID,\n  };\n\nfunction ensureHighlightStyles(color: string, styleId: string) {\n  if (document.getElementById(styleId)) return;\n  const style = document.createElement(\"style\");\n  style.id = styleId;\n  style.textContent = `\n[${HIGHLIGHT_ATTR}=\"true\"] {\n  outline: 2px solid ${color};\n  outline-offset: 2px;\n  transition: outline 0.2s ease;\n}`;\n  document.head.appendChild(style);\n}\n\nfunction parseClipboard(text: string): ClipboardParseResult {\n  if (typeof text !== \"string\") {\n    return { htmlFrame: null, codeLocation: null };\n  }\n  const htmlFrameMatch = text.match(/## HTML Frame:\\n([\\s\\S]*?)(?=\\n## Code Location:|$)/);\n  const codeLocationMatch = text.match(/## Code Location:\\n([\\s\\S]*?)(?=\\n<\\/selected_element>|$)/);\n  const selectedElementMatch = text.match(/<selected_element>\\n([\\s\\S]*?)\\n<\\/selected_element>/);\n  const htmlFrame = htmlFrameMatch\n    ? htmlFrameMatch[1].trim()\n    : selectedElementMatch\n      ? selectedElementMatch[1].trim()\n      : null;\n  const codeLocation = codeLocationMatch ? codeLocationMatch[1].trim() : null;\n  return { htmlFrame, codeLocation };\n}\n\nfunction extractFilePath(stack: string | null): string | null {\n  if (typeof stack !== \"string\") return null;\n  const pathRegex = /\\b(?:in\\s+|at\\s+)((?:[A-Za-z]:)?\\/?[^:\\s)]+?\\.(?:[jt]sx?|mdx?))/g;\n  let match: RegExpExecArray | null = null;\n  while ((match = pathRegex.exec(stack))) {\n    const candidate = match[1];\n    if (candidate) {\n      return candidate.trim();\n    }\n  }\n  return null;\n}\n\nfunction toRelativePath(filePath: string | null, projectRoot?: string): string | null {\n  if (!filePath) return null;\n  if (!projectRoot) return filePath;\n  const normalizedRoot = projectRoot.endsWith(\"/\")\n    ? projectRoot\n    : `${projectRoot}/`;\n  if (filePath.startsWith(normalizedRoot)) {\n    const sliced = filePath.slice(normalizedRoot.length);\n    return sliced.startsWith(\"/\") ? sliced.slice(1) : sliced;\n  }\n  return filePath;\n}\n\ntype Pointer = { clientX: number; clientY: number };\n\nfunction findElementAtPoint(clientX: number, clientY: number): HTMLElement | null {\n  const elements = document.elementsFromPoint(clientX, clientY);\n  for (const element of elements) {\n    if (!(element instanceof HTMLElement)) continue;\n    if (element.closest?.(\"[data-react-grab]\")) continue;\n    const style = window.getComputedStyle(element);\n    if (\n      style.pointerEvents === \"none\" ||\n      style.visibility === \"hidden\" ||\n      style.display === \"none\" ||\n      Number(style.opacity) === 0\n    ) {\n      continue;\n    }\n    return element;\n  }\n  return null;\n}\n\nfunction findTooltipElement(): HTMLElement | null {\n  const OVERLAY_SELECTOR = \"[data-react-grab=\\\"true\\\"]\";\n  const TOOLTIP_SELECTOR = \"div.pointer-events-none.bg-grab-pink-light.text-grab-pink\";\n  const visited = new Set<Node>();\n\n  const visit = (node: Node | null): HTMLElement | null => {\n    if (!node || visited.has(node)) {\n      return null;\n    }\n    visited.add(node);\n\n    if (node instanceof HTMLElement || node instanceof DocumentFragment) {\n      const queryMatch =\n        node instanceof HTMLElement ? node.querySelector<HTMLElement>(TOOLTIP_SELECTOR) : null;\n      if (queryMatch) {\n        return queryMatch;\n      }\n      const children = node instanceof HTMLElement ? Array.from(node.children) : [];\n      for (const child of children) {\n        const found = visit(child);\n        if (found) {\n          return found;\n        }\n      }\n    }\n\n    if (node instanceof HTMLElement && node.shadowRoot) {\n      return visit(node.shadowRoot);\n    }\n\n    return null;\n  };\n\n  const hosts = document.querySelectorAll<HTMLElement>(OVERLAY_SELECTOR);\n  for (const host of hosts) {\n    const found = visit(host) ?? (host.shadowRoot ? visit(host.shadowRoot) : null);\n    if (found) {\n      return found;\n    }\n  }\n  return null;\n}\n\nfunction getHoverTagRect():\n  | {\n      top: number;\n      left: number;\n      width: number;\n      height: number;\n    }\n  | null {\n  const tooltip = findTooltipElement();\n  if (!(tooltip instanceof HTMLElement)) {\n    return null;\n  }\n  const rect = tooltip.getBoundingClientRect();\n  if (rect.width === 0 && rect.height === 0) {\n    return null;\n  }\n  return {\n    top: rect.top,\n    left: rect.left,\n    width: rect.width,\n    height: rect.height,\n  };\n}\n\nfunction applyHighlight(element: HTMLElement | null) {\n  if (!element) return;\n  const previous = document.querySelector<HTMLElement>(`[${HIGHLIGHT_ATTR}=\"true\"]`);\n  if (previous && previous !== element) {\n    previous.removeAttribute(HIGHLIGHT_ATTR);\n  }\n  element.setAttribute(HIGHLIGHT_ATTR, \"true\");\n}\n\nfunction clearHighlight() {\n  const highlighted = document.querySelector<HTMLElement>(`[${HIGHLIGHT_ATTR}=\"true\"]`);\n  highlighted?.removeAttribute(HIGHLIGHT_ATTR);\n}\n\nfunction dispatchOpenEvent(detail: SelectionPayload & { tagRect: unknown }) {\n  window.dispatchEvent(\n    new CustomEvent(EVENT_OPEN, {\n      detail,\n    }),\n  );\n}\n\nexport function registerClipboardInterceptor(\n  options: ClipboardInterceptorOptions = {},\n): () => void {\n  if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\n    return () => undefined;\n  }\n\n  if ((window as unknown as Record<string, () => void>)[GLOBAL_KEY]) {\n    return (window as unknown as Record<string, () => void>)[GLOBAL_KEY];\n  }\n\n  if (!navigator.clipboard || typeof navigator.clipboard.writeText !== \"function\") {\n    console.warn(\"[shipflow-overlay] navigator.clipboard.writeText is not available.\");\n    return () => undefined;\n  }\n\n  const projectRoot = options.projectRoot;\n  const highlightColor = options.highlightColor ?? defaultOptions.highlightColor;\n  const highlightStyleId = options.highlightStyleId ?? defaultOptions.highlightStyleId;\n  const logClipboardEndpoint =\n    options.logClipboardEndpoint === undefined ? null : options.logClipboardEndpoint;\n\n  ensureHighlightStyles(highlightColor, highlightStyleId);\n  clearHighlight();\n  void loadReactGrabRuntime({ url: options.reactGrabUrl });\n\n  let lastPointer: Pointer | null = null;\n\n  const pointerListener = (event: Event) => {\n    const pointer = event as PointerEvent;\n    lastPointer = { clientX: pointer.clientX, clientY: pointer.clientY };\n  };\n\n  window.addEventListener(\"pointerup\", pointerListener, true);\n  window.addEventListener(EVENT_CLOSE, clearHighlight);\n\n  const originalWriteText = navigator.clipboard.writeText.bind(navigator.clipboard);\n\n  const overrideWriteText = async function (text: string) {\n    const parsed = parseClipboard(text);\n    const isReactGrabPayload = Boolean(parsed.htmlFrame || parsed.codeLocation);\n\n    const result = await originalWriteText(text);\n\n    if (!isReactGrabPayload) {\n      return result;\n    }\n\n    const pointer = lastPointer;\n    lastPointer = null;\n    const pointerPayload = pointer ? { x: pointer.clientX, y: pointer.clientY } : null;\n\n    let boundingRect: SelectionPayload[\"boundingRect\"] = null;\n    let element: HTMLElement | null = null;\n\n    if (pointer) {\n      element = findElementAtPoint(pointer.clientX, pointer.clientY);\n    }\n\n    if (!element) {\n      const fallback = document.querySelector<HTMLElement>(`[${HIGHLIGHT_ATTR}=\"true\"]`);\n      if (fallback) {\n        element = fallback;\n      }\n    }\n\n    if (element instanceof HTMLElement) {\n      applyHighlight(element);\n      const rect = element.getBoundingClientRect();\n      boundingRect = {\n        top: rect.top,\n        left: rect.left,\n        width: rect.width,\n        height: rect.height,\n      };\n    }\n\n    let filePath = parsed.codeLocation ? extractFilePath(parsed.codeLocation) : null;\n    filePath = filePath ? toRelativePath(filePath, projectRoot) : null;\n\n    const tagRect = getHoverTagRect();\n\n    dispatchOpenEvent({\n      htmlFrame: parsed.htmlFrame,\n      codeLocation: parsed.codeLocation,\n      filePath,\n      clipboardData: text,\n      pointer: pointerPayload,\n      boundingRect,\n      tagRect,\n    } as SelectionPayload & { tagRect: unknown });\n\n    if (logClipboardEndpoint) {\n      try {\n        await fetch(logClipboardEndpoint, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            clipboardData: text,\n            timestamp: new Date().toISOString(),\n            filePath,\n          }),\n        });\n      } catch (error) {\n        console.error(\"[shipflow-overlay] Failed to log clipboard payload\", error);\n      }\n    }\n\n    return result;\n  };\n\n  navigator.clipboard.writeText = overrideWriteText;\n\n  const cleanup = () => {\n    window.removeEventListener(\"pointerup\", pointerListener, true);\n    window.removeEventListener(EVENT_CLOSE, clearHighlight);\n    if ((navigator.clipboard.writeText as unknown) === overrideWriteText) {\n      navigator.clipboard.writeText = originalWriteText;\n    }\n    clearHighlight();\n    delete (window as unknown as Record<string, () => void>)[GLOBAL_KEY];\n  };\n\n  (window as unknown as Record<string, () => void>)[GLOBAL_KEY] = cleanup;\n  return cleanup;\n}\n","import path from \"path\";\nimport type { NextRequest } from \"next/server\";\nimport { NextResponse } from \"next/server\";\n\nimport type { StreamEvent } from \"../runtime/types\";\nimport { runCursorAgentStream, resolveCursorAgentBinary, STREAM_HEADERS } from \"./cursorAgent\";\n\nexport type ShipflowOverlayRequestPayload = {\n  filePath: string | null;\n  htmlFrame: string | null;\n  stackTrace: string | null;\n  instruction: string;\n  model?: string;\n};\n\nexport type ShipflowOverlayServerOptions = {\n  cursorAgentBinary?: string;\n  additionalSearchDirs?: string[];\n  defaultModel?: string;\n  allowInProduction?: boolean;\n  timeoutMs?: number;\n  logPrefix?: string;\n};\n\nconst DEFAULT_MODEL = \"composer-1\";\nconst STACK_TRACE_PATH_PATTERN = /([^\\s()]+?\\.(?:[jt]sx?|mdx?))/gi;\n\nconst normalizeFilePath = (filePath: string | null) => {\n  if (!filePath) return null;\n  const trimmed = filePath.trim();\n  if (!trimmed) return null;\n\n  const webpackPrefix = \"webpack-internal:///\";\n  const filePrefix = \"file://\";\n  let sanitized = trimmed;\n  if (sanitized.startsWith(webpackPrefix)) {\n    sanitized = sanitized.slice(webpackPrefix.length);\n  }\n  if (sanitized.startsWith(filePrefix)) {\n    sanitized = sanitized.slice(filePrefix.length);\n  }\n  if (sanitized.startsWith(\"./\")) {\n    sanitized = sanitized.slice(2);\n  }\n\n  if (!sanitized) {\n    return null;\n  }\n\n  const cwd = process.cwd();\n  if (pathIsAbsoluteSafe(sanitized)) {\n    const relative = relativeSafe(cwd, sanitized);\n    return relative.startsWith(\"..\") ? sanitized : relative;\n  }\n\n  return sanitized;\n};\n\nconst pathIsAbsoluteSafe = (target: string) => {\n  try {\n    return path.isAbsolute(target);\n  } catch {\n    return false;\n  }\n};\n\nconst relativeSafe = (from: string, to: string) => {\n  try {\n    return path.relative(from, to);\n  } catch {\n    return to;\n  }\n};\n\nconst extractFilePathFromStackTrace = (stackTrace: string | null) => {\n  if (!stackTrace) return null;\n\n  STACK_TRACE_PATH_PATTERN.lastIndex = 0;\n  let match: RegExpExecArray | null;\n\n  while ((match = STACK_TRACE_PATH_PATTERN.exec(stackTrace))) {\n    const rawCandidate = match[1];\n    if (typeof rawCandidate !== \"string\") {\n      continue;\n    }\n\n    let candidate = rawCandidate.trim();\n    if (!candidate) {\n      continue;\n    }\n\n    if (candidate.includes(\"node_modules/\") || candidate.includes(\"node_modules\\\\\")) {\n      continue;\n    }\n\n    if (candidate.startsWith(\"webpack-internal:///\")) {\n      candidate = candidate.slice(\"webpack-internal:///\".length);\n    }\n\n    if (candidate.startsWith(\"./\")) {\n      candidate = candidate.slice(2);\n    }\n\n    if (!candidate) {\n      continue;\n    }\n\n    return candidate;\n  }\n\n  return null;\n};\n\nconst buildPrompt = (\n  filePath: string,\n  htmlFrame: string | null,\n  stackTrace: string | null,\n  instruction: string,\n) => {\n  const lines: string[] = [];\n  lines.push(`Open ${filePath}.`);\n  lines.push(\"Target the element matching this HTML:\");\n  lines.push(htmlFrame ?? \"(no HTML frame provided)\");\n  lines.push(\"\");\n  lines.push(\"and the component stack:\");\n  lines.push(stackTrace ?? \"(no component stack provided)\");\n  lines.push(\"\");\n  lines.push(`User request: ${instruction}`);\n  return lines.join(\"\\n\");\n};\n\nconst stripNullish = <T extends Record<string, unknown>>(record: T): T =>\n  Object.fromEntries(\n    Object.entries(record).filter(([, value]) => value !== undefined && value !== null),\n  ) as T;\n\nconst isEnabled = (options: ShipflowOverlayServerOptions): boolean => {\n  if (options.allowInProduction) {\n    return true;\n  }\n  const envFlag = process.env.SHIPFLOW_OVERLAY_ENABLED;\n  if (envFlag && [\"true\", \"1\", \"on\", \"yes\"].includes(envFlag.toLowerCase())) {\n    return true;\n  }\n  return process.env.NODE_ENV === \"development\";\n};\n\nexport function createNextHandler(options: ShipflowOverlayServerOptions = {}) {\n  const logPrefix = options.logPrefix ?? \"[shipflow-overlay]\";\n\n  return async function handler(request: NextRequest) {\n    if (!isEnabled(options)) {\n      return NextResponse.json(\n        { error: \"Shipflow overlay workflow is only available in development.\" },\n        { status: 403 },\n      );\n    }\n\n    let payload: ShipflowOverlayRequestPayload;\n    try {\n      payload = (await request.json()) as ShipflowOverlayRequestPayload;\n    } catch {\n      return NextResponse.json({ error: \"Invalid JSON payload.\" }, { status: 400 });\n    }\n\n    const instruction = payload.instruction?.trim();\n    if (!instruction) {\n      return NextResponse.json({ error: \"Instruction is required.\" }, { status: 400 });\n    }\n\n    const directFilePath = normalizeFilePath(payload.filePath);\n    const derivedFilePath =\n      directFilePath ??\n      (payload.filePath\n        ? null\n        : normalizeFilePath(extractFilePathFromStackTrace(payload.stackTrace)));\n    const normalizedFilePath = derivedFilePath;\n\n    if (!normalizedFilePath) {\n      return NextResponse.json(\n        { error: \"Unable to determine target file path from stack trace.\" },\n        { status: 400 },\n      );\n    }\n\n    const prompt = buildPrompt(normalizedFilePath, payload.htmlFrame, payload.stackTrace, instruction);\n    const model = payload.model?.trim() || options.defaultModel || DEFAULT_MODEL;\n\n    try {\n      const resolved = await resolveCursorAgentBinary(\n        stripNullish({\n          binaryPath: options.cursorAgentBinary,\n          additionalSearchDirs: options.additionalSearchDirs,\n          logPrefix,\n        }),\n      );\n      const encoder = new TextEncoder();\n\n      const stream = new ReadableStream({\n        async start(controller) {\n          const state = { isClosed: false };\n\n          const send = (event: StreamEvent) => {\n            if (state.isClosed) {\n              return;\n            }\n            try {\n              controller.enqueue(encoder.encode(`${JSON.stringify(event)}\\n`));\n            } catch (error) {\n              if (\n                error instanceof TypeError &&\n                (error.message.includes(\"closed\") || error.message.includes(\"Invalid state\"))\n              ) {\n                state.isClosed = true;\n              }\n            }\n          };\n\n          request.signal.addEventListener(\"abort\", () => {\n            state.isClosed = true;\n            try {\n              controller.close();\n            } catch {\n              // ignore\n            }\n          });\n\n          send({ event: \"status\", message: \"Understanding user intent\" });\n\n          try {\n            await runCursorAgentStream(\n              {\n                binary: resolved.binary,\n                model,\n                prompt,\n                timeoutMs: options.timeoutMs,\n                logPrefix,\n                env: resolved.env,\n              },\n              send,\n            );\n          } catch (error) {\n            if (state.isClosed) {\n              return;\n            }\n            console.error(`${logPrefix} Failed during Cursor CLI streaming`, error);\n            send({\n              event: \"done\",\n              success: false,\n              summary: \"\",\n              exitCode: null,\n              error:\n                error instanceof Error\n                  ? error.message\n                  : \"Unexpected error streaming from Cursor CLI.\",\n            });\n          } finally {\n            if (!state.isClosed) {\n              try {\n                controller.close();\n              } catch {\n                // ignore\n              }\n              state.isClosed = true;\n            }\n          }\n        },\n      });\n\n      return new NextResponse(stream, {\n        headers: STREAM_HEADERS,\n      });\n    } catch (error) {\n      console.error(`${logPrefix} Failed to run cursor-agent`, error);\n      return NextResponse.json(\n        {\n          error:\n            error instanceof Error\n              ? error.message\n              : \"Failed to invoke Cursor CLI. Ensure cursor-agent is installed and available on PATH.\",\n        },\n        { status: 500 },\n      );\n    }\n  };\n}\n","import { spawn, spawnSync } from \"child_process\";\nimport { access } from \"fs/promises\";\nimport { constants as fsConstants } from \"fs\";\nimport path from \"path\";\n\nimport type { StreamEvent } from \"../runtime/types\";\n\nconst LOG_PREFIX = \"[shipflow-overlay]\";\nconst CURSOR_BINARY_HINT = process.env.CURSOR_AGENT_BIN ?? \"cursor-agent\";\nconst HOME_DIR = process.env.HOME ?? process.env.USERPROFILE ?? \"\";\n\ntype ResolveOptions = {\n  binaryPath?: string;\n  additionalSearchDirs?: string[];\n  logPrefix?: string;\n};\n\ntype ResolvedBinary = {\n  binary: string;\n  env: NodeJS.ProcessEnv | null;\n};\n\ntype RunOptions = {\n  binary: string;\n  model: string;\n  prompt: string;\n  timeoutMs?: number;\n  logPrefix?: string;\n  env?: NodeJS.ProcessEnv | null;\n};\n\nlet cachedBinary: string | null = null;\nlet cachedEnv: NodeJS.ProcessEnv | null = null;\nlet resolvePromise: Promise<ResolvedBinary> | null = null;\n\nconst IGNORED_STATUS_MESSAGES = new Set([\"User event\"]);\n\nconst WHITELISTED_STATUS_MESSAGES = new Set([\n  \"Initializing agent\",\n  \"Agent ready.\",\n  \"Thinking\",\n  \"Building changes\",\n  \"Analyzing project\",\n  \"Build step complete.\",\n]);\n\nconst MIN_STATUS_LENGTH = 30;\nconst STATUS_KEYS = [\"text\", \"value\", \"delta\", \"message\", \"summary\", \"label\"];\n\nconst STREAM_HEADERS = {\n  \"Content-Type\": \"application/x-ndjson; charset=utf-8\",\n  \"Cache-Control\": \"no-cache, no-transform\",\n};\n\nexport { STREAM_HEADERS };\n\nconst pathExistsAndExecutable = async (filePath: string) => {\n  if (!filePath) return false;\n  try {\n    await access(filePath, fsConstants.X_OK);\n    return true;\n  } catch {\n    try {\n      await access(filePath, fsConstants.F_OK);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n};\n\nconst describeEvent = (event: unknown): string | null => {\n  if (!event || typeof event !== \"object\") {\n    return null;\n  }\n\n  const payload = event as Record<string, unknown>;\n  const type = typeof payload.type === \"string\" ? payload.type : null;\n  const subtype = typeof payload.subtype === \"string\" ? payload.subtype : null;\n\n  if (type === \"system\") {\n    if (subtype === \"init\") {\n      return \"Initializing agent\";\n    }\n    if (subtype === \"progress\" && typeof payload.message === \"string\") {\n      return payload.message;\n    }\n    if (subtype === \"completed\") {\n      return \"Agent ready.\";\n    }\n    return subtype ? `System update: ${subtype}` : \"System update.\";\n  }\n\n  if (type === \"assistant\") {\n    return \"Thinkingâ€¦\";\n  }\n\n  if (type === \"tool_call\") {\n    const toolName =\n      typeof payload.tool === \"object\" &&\n      payload.tool &&\n      typeof (payload.tool as Record<string, unknown>).name === \"string\"\n        ? String((payload.tool as Record<string, unknown>).name)\n        : \"Tool\";\n    const normalizedName = toolName.toLowerCase();\n\n    if (subtype === \"started\") {\n      if (\n        normalizedName.includes(\"apply\") ||\n        normalizedName.includes(\"write\") ||\n        normalizedName.includes(\"patch\") ||\n        normalizedName.includes(\"build\")\n      ) {\n        return \"Building changesâ€¦\";\n      }\n      if (normalizedName.includes(\"plan\") || normalizedName.includes(\"analy\")) {\n        return \"Analyzing projectâ€¦\";\n      }\n      return `Running ${toolName}â€¦`;\n    }\n    if (subtype === \"completed\") {\n      if (\n        normalizedName.includes(\"apply\") ||\n        normalizedName.includes(\"write\") ||\n        normalizedName.includes(\"patch\") ||\n        normalizedName.includes(\"build\")\n      ) {\n        return \"Build step complete.\";\n      }\n      return `${toolName} finished.`;\n    }\n    return `${toolName} ${subtype ?? \"update\"}â€¦`;\n  }\n\n  if (type === \"result\") {\n    return \"Finalizing changesâ€¦\";\n  }\n\n  if (type === \"error\") {\n    if (typeof payload.message === \"string\") {\n      return `Error: ${payload.message}`;\n    }\n    return \"Cursor CLI reported an error.\";\n  }\n\n  if (typeof payload.message === \"string\") {\n    return payload.message;\n  }\n\n  return type ? `Event: ${type}${subtype ? `/${subtype}` : \"\"}` : null;\n};\n\nconst extractAssistantText = (input: unknown, seen = new WeakSet<object>()): string => {\n  if (!input) return \"\";\n  if (typeof input === \"string\") {\n    return input;\n  }\n  if (Array.isArray(input)) {\n    return input.map((entry) => extractAssistantText(entry, seen)).join(\"\");\n  }\n  if (typeof input === \"object\") {\n    if (seen.has(input as object)) return \"\";\n    seen.add(input as object);\n\n    const record = input as Record<string, unknown>;\n    let text = \"\";\n\n    for (const key of STATUS_KEYS) {\n      const value = record[key];\n      if (typeof value === \"string\") {\n        text += value;\n      } else if (value) {\n        text += extractAssistantText(value, seen);\n      }\n    }\n\n    if (\"content\" in record) {\n      text += extractAssistantText(record.content, seen);\n    }\n    if (\"parts\" in record) {\n      text += extractAssistantText(record.parts, seen);\n    }\n    if (\"text_delta\" in record) {\n      text += extractAssistantText(record.text_delta, seen);\n    }\n\n    return text;\n  }\n  return \"\";\n};\n\nconst buildCandidateDirs = (binaryPath: string | undefined, additionalSearchDirs: string[]) => {\n  const candidateDirs = new Set<string>(\n    (process.env.PATH ?? \"\")\n      .split(path.delimiter)\n      .map((entry) => entry.trim())\n      .filter(Boolean),\n  );\n\n  for (const dir of additionalSearchDirs) {\n    if (dir) {\n      candidateDirs.add(dir);\n    }\n  }\n\n  if (HOME_DIR) {\n    candidateDirs.add(path.join(HOME_DIR, \".cursor\", \"bin\"));\n    candidateDirs.add(path.join(HOME_DIR, \"Library\", \"Application Support\", \"Cursor\", \"bin\"));\n    candidateDirs.add(path.join(HOME_DIR, \"AppData\", \"Local\", \"Programs\", \"cursor\", \"bin\"));\n  }\n\n  if (binaryPath && path.isAbsolute(binaryPath)) {\n    candidateDirs.add(path.dirname(binaryPath));\n  }\n\n  return Array.from(candidateDirs);\n};\n\nasync function discoverCursorAgentBinary(options: ResolveOptions): Promise<ResolvedBinary> {\n  const additionalSearchDirs = options.additionalSearchDirs ?? [];\n  const logPrefix = options.logPrefix ?? LOG_PREFIX;\n\n  const candidateNames = new Set<string>();\n  if (options.binaryPath) {\n    candidateNames.add(options.binaryPath);\n  }\n  if (CURSOR_BINARY_HINT) {\n    candidateNames.add(CURSOR_BINARY_HINT);\n  }\n  candidateNames.add(\"cursor-agent\");\n  if (process.platform === \"win32\") {\n    candidateNames.add(\"cursor-agent.exe\");\n  }\n\n  for (const name of candidateNames) {\n    if (!name) continue;\n    if (path.isAbsolute(name)) {\n      if (await pathExistsAndExecutable(name)) {\n        return {\n          binary: name,\n          env: null,\n        };\n      }\n      continue;\n    }\n\n    const whichCommand = process.platform === \"win32\" ? \"where\" : \"which\";\n    const lookup = spawnSync(whichCommand, [name], { encoding: \"utf8\" });\n    if (!lookup.error && lookup.status === 0 && lookup.stdout) {\n      const resolvedPath = lookup.stdout.split(/\\r?\\n/).find(Boolean);\n      if (resolvedPath && (await pathExistsAndExecutable(resolvedPath))) {\n        return {\n          binary: resolvedPath,\n          env: null,\n        };\n      }\n    }\n\n    for (const dir of buildCandidateDirs(name, additionalSearchDirs)) {\n      const fullPath = path.join(dir, name);\n      if (await pathExistsAndExecutable(fullPath)) {\n        return {\n          binary: fullPath,\n          env: null,\n        };\n      }\n    }\n  }\n\n  console.error(\n    `${logPrefix} cursor-agent binary not found. Set CURSOR_AGENT_BIN to an absolute path or add cursor-agent to your PATH.`,\n  );\n  throw new Error(\n    \"cursor-agent binary not found. Set CURSOR_AGENT_BIN to an absolute path or add cursor-agent to your PATH.\",\n  );\n}\n\nexport async function resolveCursorAgentBinary(\n  options: ResolveOptions = {},\n): Promise<ResolvedBinary> {\n  if (options.binaryPath) {\n    const normalized = options.binaryPath.trim();\n    if (normalized && (await pathExistsAndExecutable(normalized))) {\n      return {\n        binary: normalized,\n        env: null,\n      };\n    }\n  }\n\n  if (cachedBinary) {\n    return {\n      binary: cachedBinary,\n      env: cachedEnv,\n    };\n  }\n\n  if (!resolvePromise) {\n    resolvePromise = discoverCursorAgentBinary(options)\n      .then((resolved) => {\n        cachedBinary = resolved.binary;\n        const extraDirs: string[] = [\n          ...(options.additionalSearchDirs ?? []),\n          path.dirname(resolved.binary),\n        ];\n        if (HOME_DIR) {\n          extraDirs.push(path.join(HOME_DIR, \".cursor\", \"bin\"));\n          extraDirs.push(path.join(HOME_DIR, \"Library\", \"Application Support\", \"Cursor\", \"bin\"));\n          extraDirs.push(path.join(HOME_DIR, \"AppData\", \"Local\", \"Programs\", \"cursor\", \"bin\"));\n        }\n\n        const existingPath = process.env.PATH ?? \"\";\n        const pathSegments = new Set<string>(\n          existingPath\n            .split(path.delimiter)\n            .map((segment) => segment.trim())\n            .filter(Boolean),\n        );\n\n        for (const dir of extraDirs) {\n          if (dir) {\n            pathSegments.add(dir);\n          }\n        }\n\n        cachedEnv = {\n          ...process.env,\n          PATH: Array.from(pathSegments).join(path.delimiter),\n        };\n\n        return {\n          binary: resolved.binary,\n          env: cachedEnv,\n        };\n      })\n      .catch((error) => {\n        resolvePromise = null;\n        throw error;\n      });\n  }\n\n  return resolvePromise;\n}\n\nexport async function runCursorAgentStream(\n  options: RunOptions,\n  send: (event: StreamEvent) => void,\n) {\n  const logPrefix = options.logPrefix ?? LOG_PREFIX;\n  await new Promise<void>((resolve) => {\n    try {\n      const args = [\n        \"--print\",\n        \"--force\",\n        \"--output-format\",\n        \"stream-json\",\n        \"--stream-partial-output\",\n        \"--model\",\n        options.model,\n        options.prompt,\n      ];\n\n      console.log(`${logPrefix} Spawning cursor-agent`, {\n        command: options.binary,\n        args,\n        cwd: process.cwd(),\n      });\n\n      const child = spawn(options.binary, args, {\n        cwd: process.cwd(),\n        env: options.env ?? process.env,\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      });\n\n      let stdoutBuffer = \"\";\n      let stderrAggregate = \"\";\n      let assistantSummary = \"\";\n      let settled = false;\n\n      const timeoutMs =\n        typeof options.timeoutMs === \"number\"\n          ? options.timeoutMs\n          : Number(process.env.SHIPFLOW_OVERLAY_AGENT_TIMEOUT_MS ?? 4 * 60 * 1000);\n\n      const sendStatus = (message: string) => {\n        if (!message) return;\n        send({ event: \"status\", message });\n      };\n\n      const appendAssistant = (text: string) => {\n        if (!text) return;\n        assistantSummary += text;\n        send({ event: \"assistant\", text });\n      };\n\n      const flushDone = (success: boolean, exitCode: number | null, error?: string) => {\n        send({\n          event: \"done\",\n          success,\n          summary: assistantSummary.trim(),\n          exitCode,\n          error,\n          stderr: stderrAggregate.trim() || undefined,\n        });\n      };\n\n      const processLine = (line: string) => {\n        if (!line.trim()) {\n          return;\n        }\n\n        try {\n          const parsed = JSON.parse(line) as Record<string, unknown>;\n          const status = describeEvent(parsed);\n          if (status) {\n            const trimmed = status.trim();\n            const isWhitelisted = WHITELISTED_STATUS_MESSAGES.has(trimmed);\n            const isIgnored = IGNORED_STATUS_MESSAGES.has(trimmed);\n            const isLongEnough = trimmed.length >= MIN_STATUS_LENGTH;\n\n            if (!isIgnored && (isWhitelisted || isLongEnough)) {\n              sendStatus(trimmed);\n            }\n          }\n\n          if (typeof parsed.type === \"string\" && parsed.type === \"assistant\") {\n            const text = extractAssistantText(parsed);\n            appendAssistant(text);\n          }\n\n          if (typeof parsed.type === \"string\" && parsed.type === \"result\") {\n            const text = extractAssistantText(parsed);\n            appendAssistant(text);\n          }\n        } catch (error) {\n          console.warn(`${logPrefix} Failed to parse cursor-agent stream line`, {\n            line,\n            error,\n          });\n          sendStatus(line);\n        }\n      };\n\n      const timeoutId = setTimeout(() => {\n        if (settled) return;\n        settled = true;\n\n        console.warn(`${logPrefix} cursor-agent exceeded timeout; terminating process`, {\n          timeoutMs,\n        });\n\n        sendStatus(`Cursor CLI timed out after ${timeoutMs}ms; terminating process.`);\n\n        try {\n          child.kill(\"SIGTERM\");\n        } catch (killError) {\n          console.warn(`${logPrefix} Failed to terminate cursor-agent process`, killError);\n        }\n\n        flushDone(false, null, `Cursor CLI timed out after ${timeoutMs}ms.`);\n        resolve();\n      }, timeoutMs);\n\n      child.stdout.on(\"data\", (chunk) => {\n        const text = chunk.toString();\n        stdoutBuffer += text;\n\n        let newlineIndex = stdoutBuffer.indexOf(\"\\n\");\n        while (newlineIndex !== -1) {\n          const line = stdoutBuffer.slice(0, newlineIndex);\n          stdoutBuffer = stdoutBuffer.slice(newlineIndex + 1);\n          processLine(line);\n          newlineIndex = stdoutBuffer.indexOf(\"\\n\");\n        }\n      });\n\n      child.stderr.on(\"data\", (chunk) => {\n        const text = chunk.toString();\n        stderrAggregate += text;\n        for (const line of text.split(/\\r?\\n/).map((entry: string) => entry.trim()).filter(Boolean)) {\n          sendStatus(`[stderr] ${line}`);\n        }\n        console.error(`${logPrefix} cursor-agent stderr:`, text);\n      });\n\n      child.on(\"error\", (error) => {\n        if (settled) return;\n        settled = true;\n        clearTimeout(timeoutId);\n        console.error(`${logPrefix} cursor-agent failed to start`, error);\n        flushDone(false, null, error instanceof Error ? error.message : \"Failed to start Cursor CLI.\");\n        resolve();\n      });\n\n      child.on(\"close\", (exitCode) => {\n        if (settled) return;\n        settled = true;\n        clearTimeout(timeoutId);\n\n        if (stdoutBuffer.trim()) {\n          processLine(stdoutBuffer);\n          stdoutBuffer = \"\";\n        }\n\n        console.log(`${logPrefix} cursor-agent exited`, { exitCode });\n\n        if (exitCode === 0) {\n          flushDone(true, exitCode ?? 0);\n        } else {\n          const error =\n            stderrAggregate.trim() ||\n            `Cursor CLI exited with status ${exitCode ?? \"unknown\"}. Check server logs for details.`;\n          flushDone(false, exitCode ?? null, error);\n        }\n\n        resolve();\n      });\n    } catch (error) {\n      console.error(`${logPrefix} Unexpected error launching cursor-agent`, error);\n      send({\n        event: \"done\",\n        success: false,\n        summary: \"\",\n        exitCode: null,\n        error: error instanceof Error ? error.message : \"Unexpected error launching Cursor CLI.\",\n      });\n      resolve();\n    }\n  });\n}\n"],"mappings":"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","names":["_a","script","_a","_b","EVENT_OPEN","EVENT_CLOSE","_a","_b","import_path","_a","fsConstants","_a","path","_b","path","_a","_b"]}